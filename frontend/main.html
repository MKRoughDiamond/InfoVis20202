<html>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<head>
    <link rel="stylesheet" href="style.css"/>
    <style type="text/css">
        html, body, h1, h2, h3, h4, h5, h6 {
            font-family: "Roboto", sans-serif;
            font-weight: bold
        }
    </style>
</head>
<body>
<h1 class="w3-text-teal">High-Dimensional Latent Space Visualization</h1>
<h2 class="w3-text-teal">InfoVis 2020 Term Project - Group E</h2>

<div style="padding-left:20px">
    <div style="width: 1300px; height: 20px">
        <div style="float: left; width: 500px; height: 15px">
            <b>(A) Overall Visualization(t-SNE)</b>
        </div>
        <div style="float: right; width: 800px; height: 15px">
            <b style="float: right">(B) Latent Space Traversal (2 dimension)</b>
        </div>
    </div>
    <div style="width: 1300px; height: 400px">
        <div class="w3-border" id="A" style="float: left; width: 500px; height: 400px"></div>
        <div class="w3-border" id="B" style="float: right; width: 795px; height: 400px">
            <div class="w3-border" id="B_slider"
                 style="text-align: center; float: left; width:390px; height:400px; padding:8px 5px"></div>
            <div class="w3-border" id="B_image"
                 style="float: right; width:400px; height:400px"></div>
        </div>
    </div>
    <div style="width: 1300px; height: 400px">
        <div class="w3-border" id="C" style="float: left; width: 1300px; height: 400px"></div>
    </div>
    <div>
        <div style="float: left; width: 1300px; height: 15px">
            <b style="float: right">(C) User input(Drawing)</b>
        </div>
    </div>
</div>


</body>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="config.js"></script>

<script>
    function translate(x, y) {
        return 'translate(' + x + ', ' + y + ')';
    }
</script>

<script>
    const url = "http://" + host + ":" + port;
    const margin = {left: 50, right: 50, top: 20, bottom: 20, internal: 20};
    const AWidth = 500;
    const BWidth = 780;
    const AImageWidth = 100;
    const AImageHeight = 100;
    const ABHeight = 400;
    const CWidth = 1300;
    const CHeight = 400;
    const num_latent = 10;
    const num_row_B_image = 5; // 5x5=25개의 이미지가 표시됨

    let dimension_range = {'min': [], 'max': []};
    let target_idx = [0, 1];
    let latent_values = new Array(num_latent).fill(0);
    let num_checked = 2;

    let svgA = d3.select('#A').append('svg').attr('width', AWidth).attr('height', ABHeight);
    let svgB = d3.select('#B').append('svg').attr('width', BWidth).attr('height', ABHeight);
    let svgC = d3.select('#C').append('svg').attr('width', CWidth).attr('height', CHeight);

    makeSectionA();
    makeSectionB();
    makeSectionC();

    function makeSectionA() {
        svgA.append('rect').attr('width', AWidth).attr('height', ABHeight).style('fill', 'none');

        tsne = fetch(url, {
            method: "POST",
            body: JSON.stringify({opcode: 'tsne', content: []})
        }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Error");
                    return;
                }
                return response.json();
            }
        );
        tsne.then((data) => {
            data = data.content;
            circles = svgA.selectAll('circle').data(data).enter().append('circle');
            let xRange = d3.max(data, d => d.tsne_pos[0]) - d3.min(data, d => d.tsne_pos[0]);
            let yRange = d3.max(data, d => d.tsne_pos[1]) - d3.min(data, d => d.tsne_pos[1]);
            let xScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.tsne_pos[0]) - xRange * 0.1, d3.max(data, d => d.tsne_pos[0]) + xRange * 0.1])
                .range([5, AWidth - 5]);
            let yScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.tsne_pos[1]) - yRange * 0.1, d3.max(data, d => d.tsne_pos[1]) + yRange * 0.1])
                .range([ABHeight - 5, 5]);
            circles.style('fill', `rgb(0, 0, 0)`).attr('r', 5)
                .attr('cx', d => xScale(d.tsne_pos[0]))
                .attr('cy', d => yScale(d.tsne_pos[1]))
                .style('fill', d => d3.schemeCategory10[d.label])
                .on('mouseenter', function (event, d) {
                    d3.select(this).attr('r', 10);
                    x = xScale(d.tsne_pos[0]);
                    y = yScale(d.tsne_pos[1]);
                    if (x + AImageWidth > AWidth)
                        x -= AImageWidth;
                    if (y + AImageHeight > ABHeight)
                        y -= AImageHeight;

                    svgA.append('svg:image').attr('xlink:href', 'data:image/jpg;base64,' + d.img)
                        .attr('x', x).attr('y', y)
                        .attr('width', AImageWidth).attr('height', AImageHeight).attr('id', 'img');
                })
                .on('mouseleave', function (event, d) {
                    d3.select(this).attr('r', 5);
                    svgA.select('#img').remove();
                })
                .on('click', function (event, d) {
                    let sliders = d3.selectAll("input.slider");
                    sliders.each(function (d_, i) {
                        this.value = d.latent[i];
                        this.oninput();
                        latent_values[i] = d.latent[i];
                    })
                    update_B_image();
                });
        });
    }

    function make_slider_row(i, min_value, max_value) {
        i = i.toString();
        let set_value = (min_value + (max_value - min_value) * Math.random()).toFixed(3).toString();
        min_value = min_value.toFixed(3).toString();
        max_value = max_value.toFixed(3).toString();
        let slider_row = document.createElement('div')
        slider_row.setAttribute('style', 'height: ' + (400 / num_latent).toString())

        let div_checkbox = document.createElement('div')
        div_checkbox.setAttribute('style', "float:left; width:30px")

        let checkbox = document.createElement('input')
        checkbox.setAttribute('type', 'checkbox')
        checkbox.setAttribute('name', 'latent')
        checkbox.setAttribute('value', i)
        checkbox.setAttribute('class', 'checkbox')
        checkbox.setAttribute('style', "width:20px; height:20px;")

        div_checkbox.appendChild(checkbox)
        slider_row.appendChild(div_checkbox)

        let div_min = document.createElement('div')
        div_min.setAttribute('style', "float:left; width:50px")
        div_min.innerHTML = min_value
        slider_row.appendChild(div_min)

        let div_slider = document.createElement('div')
        div_slider.setAttribute('style', "float:left; width:200px")

        let slider = document.createElement('input')
        slider.setAttribute('type', 'range')
        slider.setAttribute('min', min_value)
        slider.setAttribute('max', max_value)
        slider.setAttribute('step', '0.001')
        slider.setAttribute('class', 'slider')
        slider.setAttribute('id', 'B_slider' + i.toString())

        div_slider.appendChild(slider)
        slider_row.appendChild(div_slider)

        let div_max = document.createElement('div')
        div_max.setAttribute('style', "float:left; width:50px")
        div_max.innerHTML = max_value
        slider_row.appendChild(div_max)


        let div_text = document.createElement('div')
        div_text.setAttribute('style', "float:left; width:40px")
        let p = document.createElement('p')
        p.innerHTML = set_value
        div_text.appendChild(p)
        slider_row.appendChild(div_text)


        if (i < 2) {
            checkbox.setAttribute('checked', '')
            slider.disabled = true;
        } else {
            checkbox.disabled = true;
        }

        // checkbox 체크/체크 해제 시
        checkbox.addEventListener('change', (event) => {
            let checkboxes = d3.selectAll('input.checkbox');
            if (event.target.checked) {
                num_checked += 1;
                if (num_checked >= 2) {
                    // checkbox 비활성화
                    checkboxes.each(function(){
                        if(this.checked === false){
                            this.disabled = true;
                        }
                    })
                    // image 영역 업데이트
                    update_B_image();
                }
                slider.disabled = true;
            } else {
                num_checked -= 1;
                checkboxes.each(function(){
                    this.disabled = false;
                })
                slider.disabled = false;
            }
        })

        // slider 이동 시
        slider.oninput = function () {
            p.innerHTML = slider.value;
        }

        // slider 이동이 끝날 시
        slider.onchange = function () {
            latent_values[i] = slider.value;
            if(num_checked === 2){
                // image 영역 업데이트
                update_B_image();
            }
        }

        slider.setAttribute('value', set_value)
        latent_values[i] = slider.value;

        return slider_row
    }

    function update_B_image() {


        target_idx = [];
        let target_checkboxes = d3.selectAll("input.checkbox:checked");
        target_checkboxes.each(function () {
            target_idx.push(this.value);
        })
        d3.select('#B_yAxis').text(target_idx[0]);
        d3.select('#B_xAxis').text(target_idx[1]);

        if (target_idx.length !== 2) {
            console.log('Select only 2 target dimensions.')
        } else {
            // Backend에서 data 받아오기
            let tsne = fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    opcode: 'latent_imgs',
                    content: [
                        {
                            'latent': latent_values,
                            'target_idx': target_idx
                        }
                    ]
                })
            }).then(
                function (response) {
                    if (!response.ok) {
                        console.log("Response Error: opcode='latent_imgs'");
                        return;
                    }
                    return response.json();
                }
            )

            tsne.then((data) => {
                data = data.content;
                for (let i = 0; i < num_row_B_image; i++) {
                    for (let j = 0; j < num_row_B_image; j++) {
                        d3.select('g.row' + i.toString()+'column' + j.toString())
                            .append('svg:image').attr('xlink:href', 'data:image/jpg;base64,' + data[i*num_row_B_image+j].img)
                            .attr('width', '68').attr('height', '68');
                    }
                }
            })
        }
    }

    function makeSectionB() {
        let B = document.getElementById('B');

        let B_slider = document.getElementById('B_slider');
        // let B_image = document.getElementById('B_image');

        let dimension_minmax = fetch(url, {
            method: 'POST',
            body: JSON.stringify({opcode: 'min_max', content: []})
        }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Response Error: opcode='min_max'");
                    return;
                }
                return response.json();
            }
        )

        dimension_minmax.then((data) => {
            dimension_range = data.content[0];

            for (let i = 0; i < num_latent; i++) {
                let obj = make_slider_row(i, dimension_range.min[i], dimension_range.max[i])
                B_slider.appendChild(obj)
            }
            update_B_image()
        })


        // 이미지 5x5 만들기
        // 테두리는 삭제해도 됨(경계 구분 위함)

        let B_image = d3.select('#B_image').append('svg').attr('width', 400).attr('height', 400);

        let image_margin = 20;

        // 2개의 latent variable 축 생성
        B_image.append('text').attr('id', 'B_yAxis').attr('transform', translate(5, ABHeight / 2 + 6)).text(target_idx[0]);
        B_image.append('text').attr('id', 'B_xAxis').attr('transform', translate(ABHeight / 2 - 3, ABHeight - 5)).text(target_idx[1]);

        // 5x5 image 영역 생성
        let image_area = B_image.append('g')
            .attr('transform', translate(image_margin,image_margin));

        let wh = ABHeight - 2*image_margin;

        image_area.append('rect')
            .attr('width', wh).attr('height', wh)
            .style('fill', 'none').style('stroke', 'red');

        for (let i = 0; i < num_row_B_image; i++) {
            let i_row_image = image_area.append('g')
                .attr('transform', translate(0, (wh / num_row_B_image * i).toString()));

            i_row_image.append('rect')
                .attr('width', wh).attr('height', wh / num_row_B_image)
                .attr('class', 'row' + i.toString())
                .style('fill', 'none').style('stroke', 'yellow');

            for (let j = 0; j < num_row_B_image; j++) {
                let j_column_image = i_row_image.append('g')
                    .attr('transform', translate((wh / num_row_B_image * j).toString() , 0));

                j_column_image.append('g')
                    .attr('width', wh / num_row_B_image - 4).attr('height', wh / num_row_B_image - 4)
                    .attr('transform', translate(2,2))
                    .attr('class', 'row'+i.toString()+'column' + j.toString())
                    .style('fill', 'none').style('stroke', 'green');
            }
        }

    }

    function makeSectionC() {
        svgC.append('rect').attr('width', CWidth).attr('height', CHeight).style('fill', 'none');
    }

</script>
</html>
