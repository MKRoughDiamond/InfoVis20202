<html>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<head>
    <link rel="stylesheet" href="style.css"/>
    <style type="text/css"></style>
</head>
<body>
<div style="width: 1300px;float: left;margin-left:20px">
    <div style="float: left">
        <h3 class="w3-text-teal">High-Dimensional Latent Space Visualization</h3>
    </div>
    <div style="float: right">
        <h3 class="w3-text-teal">InfoVis 2020 Term Project - Group E</h3>
    </div>
</div>
<div style="width: 1300px;float: left;margin-left:20px">
    <input type="range" id="num_row_b_image_slider" min="3" max="11" value="5" step="2"/>
    <p id="num_row_b_image_text">5</p>
</div>

<div style="padding-left:20px; float: left">
    <div style="width: 1300px; height: 20px">
        <div style="float: left; width: 500px; height: 15px">
            <b>(A) Overall Visualization(t-SNE)</b>
        </div>
        <div style="float: right; width: 800px; height: 15px">
            <b style="float: right">(B) Latent Space Traversal (2 dimension)</b>
        </div>
    </div>
    <div style="width: 1300px; height: 400px">
        <div class="w3-border" id="A" style="float: left; width: 500px; height: 400px"></div>
        <div id="B" style="float: right; width: 795px; height: 400px">
            <div class="w3-border" id="B1"
                 style="text-align: center; float: left; width:390px; height:400px; padding:8px 5px"></div>
            <div class="w3-border" id="B2"
                 style="float: right; width:400px; height:400px"></div>
        </div>
    </div>
    <div style="width: 1300px; height: 400px; margin-top: 5px">
        <div id="C" style="float: left; width: 1300px; height: 400px">
            <div class="w3-border" id="C1"
                 style="text-align: center; float: left; width:500px; height:400px">
                <div id="canvas-container"><canvas id="canvas"></canvas></div>
                <div style="width: 50px; float: right; padding-top: 10px">
                    <label class="c-button" title="upload image">
                        <input type="file" id="upload_image" accept="image/*" style="display: none">
                        <image src="image/upload.png" width="40" height="40"></image>
                    </label>
                    <button id="draw_image" class="c-button" value='0' title="draw image">
                        <image src="image/draw.png" width="40" height="40"></image>
                    </button>
                    <button id="update_image" class="c-button" style="margin-top: 200px" title="analyze image">
                        <image src="image/update.png" width="40" height="40"></image>
                    </button>
                </div>
                <div style="width: 50px; float: right; padding-top: 10px">
                    <button id="clear" class="c-button c-button-red" style="margin-top: 48px; display: none">clear</button>
                    <button id="undo" class="c-button c-button-green" style="display: none">undo</button>
                    <button id="redo" class="c-button c-button-blue" style="display: none">redo</button>
                </div>
            </div>
            <div class="w3-border" id="C3"
                 style="float: right; width:795px; height:400px; padding:5px"></div>
        </div>
    </div>
    <div>
        <div style="float: left; width: 1300px; height: 15px">
            <b style="float: right">(C) User input(Drawing)</b>
        </div>
    </div>
</div>
</body>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="canvas-free-drawing.min.js"></script>
<script src="config.js"></script>

<script>
    function translate(x, y) {
        return 'translate(' + x + ', ' + y + ')';
    }
</script>

<script>
    const url = "http://" + host + ":" + port;
    const margin = {left: 50, right: 50, top: 20, bottom: 20, internal: 20};
    const AWidth = 500;
    const BWidth = 780;
    const AImageWidth = 100;
    const AImageHeight = 100;
    const ABHeight = 400;
    const CWidth = 1300;
    const C3Width = 780;
    const CHeight = 400;
    const num_latent = 10;

    let num_row_B_image = 5; // 5x5=25개의 이미지가 표시됨
    let vis_C_length = 11;

    let dimension_range = {'min': [], 'max': []};
    let target_idx = [0, 1];
    let latent_values = new Array(num_latent).fill(0);
    let num_checked = 2;

    let svgA = d3.select('#A').append('svg').attr('width', AWidth).attr('height', ABHeight);
    let svgB = d3.select('#B').append('svg').attr('width', BWidth).attr('height', ABHeight);
    let svgC = d3.select('#C').append('svg').attr('width', CWidth).attr('height', CHeight);

    let B2_image_WH = 68; // sectionB2의 1개의 이미지 크기(5x5일 때 68x68 pixel)

    let drawingCanvas;
    let drawingCanvasWidth = 344;
    let drawingCanvasHeight = 344;

    fetch(url, {
        method: "GET"
    }).then(
        function (response) {
            if (!response.ok) {
                console.log("Connection Error");
                return;
            }
            return response.json();
        }
    ).then((data) => {
        params = data.content;
        console.log(params);
        makeTemporalNumRowSlider()
        makeSectionA();
        makeSectionB2();
        makeSectionC();
        makeSectionC3();

        // for test
        makeSectionC1();
    });

    /* Section A */

    function makeSectionA() {
        svgA.append('rect').attr('width', AWidth).attr('height', ABHeight).style('fill', 'none');

        tsne = fetch(url, {
            method: "POST",
            body: JSON.stringify({opcode: 'tsne', content: []})
        }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Error");
                    return;
                }
                return response.json();
            }
        );
        tsne.then((data) => {
            data = data.content;
            console.log('latent_values:', latent_values)
            latent_values = data[0].latent;
            console.log('latent_values:', latent_values)
            circles = svgA.selectAll('circle').data(data).enter().append('circle');
            let xRange = d3.max(data, d => d.tsne_pos[0]) - d3.min(data, d => d.tsne_pos[0]);
            let yRange = d3.max(data, d => d.tsne_pos[1]) - d3.min(data, d => d.tsne_pos[1]);
            let xScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.tsne_pos[0]) - xRange * 0.1, d3.max(data, d => d.tsne_pos[0]) + xRange * 0.1])
                .range([5, AWidth - 5]);
            let yScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.tsne_pos[1]) - yRange * 0.1, d3.max(data, d => d.tsne_pos[1]) + yRange * 0.1])
                .range([ABHeight - 5, 5]);
            circles.style('fill', `rgb(0, 0, 0)`).attr('r', 5)
                .attr('cx', d => xScale(d.tsne_pos[0]))
                .attr('cy', d => yScale(d.tsne_pos[1]))
                .style('fill', d => d3.schemeCategory10[d.label])
                .on('mouseenter', function (event, d) {
                    d3.select(this).attr('r', 10);
                    x = xScale(d.tsne_pos[0]);
                    y = yScale(d.tsne_pos[1]);
                    if (x + AImageWidth > AWidth)
                        x -= AImageWidth;
                    if (y + AImageHeight > ABHeight)
                        y -= AImageHeight;

                    svgA.append('svg:image').attr('xlink:href', 'data:image/jpg;base64,' + d.img)
                        .attr('x', x).attr('y', y)
                        .attr('width', AImageWidth).attr('height', AImageHeight).attr('id', 'img');
                })
                .on('mouseleave', function (event, d) {
                    d3.select(this).attr('r', 5);
                    svgA.select('#img').remove();
                })
                .on('click', function (event, d) {
                    updateSectionB1(event, d);
                    updateSectionB2();
                    updateSectionC3();
                });

            // 첫번째 point latent를 대표 latent로 삼아야 해서 여기다 배치함
            makeSectionB1();
            updateSectionC3();
        });
    }

    /* Section B */

    function make_slider_row(i, min_value, max_value, step='0.001') {
        i = i.toString();
        // let set_value = (min_value + (max_value - min_value) * Math.random()).toFixed(3).toString();
        let set_value = latent_values[i].toFixed(3).toString();
        min_value = min_value.toFixed(3).toString();
        max_value = max_value.toFixed(3).toString();
        let slider_row = document.createElement('div')
        slider_row.setAttribute('style', 'height: ' + (400 / num_latent).toString())

        let div_checkbox = document.createElement('div')
        div_checkbox.setAttribute('style', "float:left; width:30px")

        let checkbox = document.createElement('input')
        checkbox.setAttribute('type', 'checkbox')
        checkbox.setAttribute('name', 'latent')
        checkbox.setAttribute('value', i)
        checkbox.setAttribute('class', 'checkbox')
        checkbox.setAttribute('style', "width:20px; height:20px;")

        div_checkbox.appendChild(checkbox)
        slider_row.appendChild(div_checkbox)

        let div_min = document.createElement('div')
        div_min.setAttribute('style', "float:left; width:50px")
        div_min.innerHTML = min_value
        slider_row.appendChild(div_min)

        let div_slider = document.createElement('div')
        div_slider.setAttribute('style', "float:left; width:200px")

        let slider = document.createElement('input')
        slider.setAttribute('type', 'range')
        slider.setAttribute('min', min_value)
        slider.setAttribute('max', max_value)
        slider.setAttribute('step', step)
        slider.setAttribute('class', 'slider')
        slider.setAttribute('id', 'B_slider' + i.toString())

        div_slider.appendChild(slider)
        slider_row.appendChild(div_slider)

        let div_max = document.createElement('div')
        div_max.setAttribute('style', "float:left; width:50px")
        div_max.innerHTML = max_value
        slider_row.appendChild(div_max)


        let div_text = document.createElement('div')
        div_text.setAttribute('style', "float:left; width:40px")
        let p = document.createElement('p')
        p.innerHTML = set_value
        div_text.appendChild(p)
        slider_row.appendChild(div_text)


        if (i < 2) {
            checkbox.setAttribute('checked', '')
            slider.disabled = true;
        } else {
            checkbox.disabled = true;
        }

        // checkbox 체크/체크 해제 시
        checkbox.addEventListener('change', (event) => {
            let checkboxes = d3.selectAll('input.checkbox');
            if (event.target.checked) {
                num_checked += 1;
                if (num_checked >= 2) {
                    // checkbox 비활성화
                    checkboxes.each(function(){
                        if(this.checked === false){
                            this.disabled = true;
                        }
                    })
                    // image 영역 업데이트
                    updateSectionB2();
                    updateSectionC3();
                }
                slider.disabled = true;
            } else {
                num_checked -= 1;
                checkboxes.each(function(){
                    this.disabled = false;
                })
                slider.disabled = false;
            }
        })

        // slider 이동 시
        slider.oninput = function () {
            p.innerHTML = slider.value;
        }

        // slider 이동이 끝날 시
        slider.onchange = function () {
            latent_values[i] = slider.value;
            if(num_checked === 2){
                // image 영역 업데이트
                updateSectionB2();
                updateSectionC3();
            }
        }

        slider.setAttribute('value', set_value)
        latent_values[i] = slider.value;

        return slider_row
    }

    function makeSectionB1() {
        let B_slider = document.getElementById('B1');

        let dimension_minmax = fetch(url, {
            method: 'POST',
            body: JSON.stringify({opcode: 'min_max', content: []})
        }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Response Error: opcode='min_max'");
                    return;
                }
                return response.json();
            }
        )

        dimension_minmax.then((data) => {
            dimension_range = data.content[0];

            for (let i = 0; i < num_latent; i++) {
                let obj = make_slider_row(i, dimension_range.min[i], dimension_range.max[i])
                B_slider.appendChild(obj)
            }
            updateSectionB2()
        })
    }

    function makeSectionB2(){
        // 이미지 N x N 만들기

        d3.select('#svg_under_B2').remove();

        let B_image = d3.select('#B2').append('svg')
            .attr('id', 'svg_under_B2')
            .attr('width', 400).attr('height', ABHeight);

        let image_margin = 20;

        // 2개의 latent variable 축 생성
        B_image.append('text').attr('id', 'B_yAxis').attr('transform', translate(5, ABHeight / 2 + 6)).text(target_idx[0]);
        B_image.append('text').attr('id', 'B_xAxis').attr('transform', translate(ABHeight / 2 - 3, ABHeight - 5)).text(target_idx[1]);

        let wh = ABHeight - 2*image_margin;
        B2_image_WH = wh / num_row_B_image;

        // nxn image 영역 생성
        B_image.append('g')
            .attr('id', 'nxn_g')
            .attr('transform', translate(image_margin,image_margin))
            .attr('width', wh).attr('height', wh);

    }

    function updateSectionB1(event, d){
        let sliders = d3.selectAll("input.slider");
        sliders.each(function (d_, i) {
            this.value = d.latent[i];
            this.oninput();
            latent_values[i] = d.latent[i];
        })
    }

    function updateSectionB2() {
        console.log('updateSectionB2')

        target_idx = [];
        let target_checkboxes = d3.selectAll("input.checkbox:checked");
        target_checkboxes.each(function () {
            target_idx.push(this.value);
        })
        d3.select('#B_yAxis').text(target_idx[0]);
        d3.select('#B_xAxis').text(target_idx[1]);

        if (target_idx.length !== 2) {
            console.log('Select only 2 target dimensions.')
        } else {
            // Backend에서 data 받아오기
            let res = fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    opcode: 'latent_imgs',
                    content: [
                        {
                            'latent': latent_values,
                            'target_idx': target_idx
                        }
                    ]
                })
            }).then(
                function (response) {
                    if (!response.ok) {
                        console.log("Response Error: opcode='latent_imgs'");
                        return;
                    }
                    return response.json();
                }
            )

            res.then((data) => {
                updateSectionC1(data);
                console.log('data.content.tile:',data.content.tile)
                data = data.content.tile;

                let nxn_g = d3.select('#nxn_g');
                let image_areas = nxn_g.selectAll('image').data(data);
                image_areas.enter().append('svg:image')
                    .merge(image_areas)
                    .attr('xlink:href', d => 'data:image/jpg;base64,' + d.img)
                    .attr('width', B2_image_WH)
                    .attr('height', B2_image_WH)
                    .attr('transform', (d, i) =>
                        translate(
                            B2_image_WH * (i % num_row_B_image),
                            B2_image_WH * parseInt(i / num_row_B_image)
                        ))
                    .on('click', function(event, d){
                        latent_values = d.latent.map(x => x.toFixed(3).toString());
                        updateSectionB1(event, d);
                        updateSectionB2();
                        updateSectionC3();
                    })
            })
        }
    }

    // B2의 이미지 개수를 조절하기 위한 임시 slider를 control함
    function makeTemporalNumRowSlider(){
        let num_row_b_image_slider = document.getElementById('num_row_b_image_slider');
        let num_row_b_image_text = document.getElementById('num_row_b_image_text');
        num_row_b_image_slider.onchange = function(){
            num_row_B_image = parseInt(num_row_b_image_slider.value);

            fetch(url, {
                method: "POST",
                body: JSON.stringify({
                    opcode: 'set_param',
                    content: [{
                        'param_name': 'vis_B_shape',
                        'value': [num_row_B_image, num_row_B_image]
                    }]})
            }).then(
                function (response) {
                    if (!response.ok) {
                        console.log("set_param Error: vis_B_shape <- [num, num]");
                        return;
                    }
                    console.log('set vis_B_shape')
                    return response.json();
                }
            );
            makeSectionB2();
            updateSectionB2();
        }
        num_row_b_image_slider.oninput = function() {
            num_row_b_image_text.innerHTML = num_row_b_image_slider.value;
        }

    }

    /* Section C */
    // user input implementation

    function makeSectionC() {
        // svgC.append('rect').attr('width', CWidth).attr('height', CHeight).style('fill', 'none');
    }

    function enableDrawing(enable=true) {
        let draw_button = document.getElementById('draw_image');

        if(enable) {
            draw_button.value = '1';
            drawingCanvas.clear();
            document.getElementById('clear').style.display = 'block';
            document.getElementById('undo').style.display = 'block';
            document.getElementById('redo').style.display = 'block';
            drawingCanvas.enableDrawingMode();
        }
        else {
            draw_button.value = '0';
            document.getElementById('clear').style.display = 'none';
            document.getElementById('undo').style.display = 'none';
            document.getElementById('redo').style.display = 'none';
            drawingCanvas.disableDrawingMode();
        }
    }

    function makeCanvas() {
        const cfd = new CanvasFreeDrawing.default({
            elementId: 'canvas',
            width: drawingCanvasWidth,
            height: drawingCanvasHeight,
        });

        // set properties
        cfd.setLineWidth(30); // in px
        cfd.setStrokeColor([255, 255, 255]); // in RGB
        cfd.setBackground([0, 0, 0], true); // in RGB

        // listen to events
        document.getElementById('clear').onclick = () => cfd.clear();
        document.getElementById('undo').onclick = () => cfd.undo();
        document.getElementById('redo').onclick = () => cfd.redo();

        let draw_button = document.getElementById('draw_image');
        draw_button.onclick = function() {
            if (draw_button.value === '0') {
                enableDrawing(true);
            }
            else {
                enableDrawing(false);
            }
        };

        return cfd;
    }

    function makeSectionC1() {
        const inputElement = document.getElementById("upload_image");

        inputElement.addEventListener("change", handleFiles, false);
        function handleFiles() {
            const file = this.files[0];

            if (FileReader && file) {
                let fr = new FileReader();
                fr.onload = function () {
                    updateCanvas(fr.result);
                };
                fr.readAsDataURL(file);
            }
        }

        drawingCanvas = makeCanvas();

        document.getElementById("upload_image").onclick = () => enableDrawing(false);

        document.getElementById("update_image").onclick = function() {
            // TODO (backend) - Query: 이미지를 전송(base64), Response: 이미지의 latent value, tile img, linear img
            let fetch_response = fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    opcode: 'encode_img',
                    content: [
                        {
                            'img': drawingCanvas.save()
                        }
                    ]
                })
            }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Response Error: opcode='encode_img'");
                    return;
                }
                return response.json();
            });

            fetch_response.then((data) => {
                updateSectionC1(data);
                // TODO (frontend) - Section B, C 부분 update
                // TODO (frontend) - 업로드하면 대표 latent값도 바뀌게 되는데 B1 슬라이더에 변경된 값 반영할 것
            });
        };

        enableDrawing(false);
    }

    function updateCanvas(image){
        // canvas.attr('xlink:href', image).attr('width', width).attr('height', height);
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext("2d");
        let imgClo = new Image(drawingCanvasWidth, drawingCanvasHeight);
        imgClo.onload = function() {
            ctx.drawImage(imgClo, 0, 0, drawingCanvasWidth, drawingCanvasHeight);
        };
        imgClo.src = image;
        enableDrawing(false);
    }

    // backend로부터 fetch_response의 data를 입력받아서 C1의 canvas 이미지를 그려줌.
    function updateSectionC1(data) {
        data = data.content.tile;
        let middleIdx = (num_row_B_image - 1) / 2;
        let idx = middleIdx * num_row_B_image + middleIdx;
        updateCanvas('data:image/jpg;base64,' + data[idx].img);
    }

    function makeSectionC3(){

        d3.select('#svg_under_C3').remove();

        let C_image = d3.select('#C3').append('svg')
            .attr('id', 'svg_under_C3')
            .attr('width', C3Width).attr('height', CHeight);

        let image_margin = 0;

        C_image.append('g')
            .attr('id', 'mxn_g')
            .attr('transform', translate(image_margin, image_margin))
            .attr('width', C3Width - 2*image_margin)
            .attr('height', CHeight - 2*image_margin);

    }


    function updateSectionC3(){
        let res = fetch(url, {
            method: 'POST',
            body: JSON.stringify({
                opcode: 'latent_imgs',
                content: [
                    {
                        'latent': latent_values,
                        'target_idx': target_idx
                    }
                ]
            })
        }).then(
            function (response) {
                if (!response.ok) {
                    console.log("Response Error: opcode='latent_imgs'");
                    return;
                }
                return response.json();
            }
        )

        width = 795 / vis_C_length;
        height = 390 / num_latent;
        console.log('width, height:', width, height)

        res.then((data) => {
            updateSectionC1(data);  // TODO (front) 577 todo 부분 넣어둔 예시. 필요한 모든 부분에 저렇게 넣으면 됨.
            console.log('data.content.linear', data.content.linear)
            data = data.content.linear;

            let nxn_g = d3.select('#mxn_g');
            let image_areas = nxn_g.selectAll('image').data(data);
            image_areas.enter().append('svg:image')
                .merge(image_areas)
                .attr('xlink:href', d => 'data:image/jpg;base64,' + d.img)
                .attr('width', width)
                .attr('height', height)
                .attr('transform', (d, i) =>
                    translate(
                        width  * (i % vis_C_length),
                        height * parseInt(i / vis_C_length),
                    ))
                .on('click', function(event, d){
                    latent_values = d.latent.map(x => x.toFixed(3).toString());
                    updateSectionB1(event, d);
                    updateSectionB2();
                    updateSectionC3();
                })
        })

    }

</script>
</html>
