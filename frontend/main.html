<html>
<body>
    <h1>High-Dimensional Latent Space Visualization</h1>
    <h2>InfoVis 2020 Term Project - Group E</h2>
</body>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="config.js"></script>

<script>
    const url= "http://"+host+":"+port;
    const margin = {left : 50, right : 50, top: 20, bottom: 20, internal : 20};
    const AWidth = 500;
    const BWidth = 780;
    const ABHeight =400;
    const CWidth = 1300;
    const CHeight = 400;
  
    let svg = d3.select('body').append('svg')
	.attr('width', Math.max(CWidth, AWidth + BWidth + margin.internal) + margin.left + margin.right)
	.attr('height', ABHeight + CHeight + margin.top + margin.bottom + margin.internal);
    let svgA = svg.append('g').attr('width', AWidth).attr('height', ABHeight)
	.attr('transform', `translate(${margin.left}, ${margin.top})`);
    let svgB = svg.append('g').attr('width', BWidth).attr('height', ABHeight)
	.attr('transform', `translate(${margin.left + AWidth + margin.internal}, ${margin.top})`);
    let svgC = svg.append('g').attr('width', CWidth).attr('height', CHeight)
	.attr('transform', `translate(${margin.left}, ${margin.top + ABHeight + margin.internal})`);

    makeSectionA();
    makeSectionB();
    makeSectionC();

    function makeSectionA() {
        svgA.append('rect').attr('width', AWidth).attr('height', ABHeight)
	.style('fill', 'none').style('stroke', 'red');
        
        
        tsne = fetch(url, {
        	method: "POST",
          body: JSON.stringify({opcode:'tsne', content:[]})
        }).then(
        	function(response){
          	if(!response.ok){
            	console.log("Error");
              return;
            }
            return response.json();
          }
        );
        tsne.then((data) => {
	data = data.content;
            circles = svgA.selectAll('circle').data(data).enter().append('circle');
    let xRange = d3.max(data,d => d.tsne_pos[0]) - d3.min(data, d=> d.tsne_pos[0]);
    let yRange = d3.max(data,d => d.tsne_pos[1]) - d3.min(data, d=> d.tsne_pos[1]);
	let xScale = d3.scaleLinear()
		.domain([d3.min(data, d => d.tsne_pos[0])-xRange*0.1, d3.max(data, d => d.tsne_pos[0])+xRange*0.1])
		.range([5, AWidth-5]);
	let yScale = d3.scaleLinear()
		.domain([d3.min(data, d => d.tsne_pos[1])-yRange*0.1, d3.max(data, d => d.tsne_pos[1])+yRange*0.1])
		.range([ABHeight-5, 5]);
	circles.style('fill', `rgb(0, 0, 0)`)
	      .attr('r', 5)
	      .attr('cx', d => xScale(d.tsne_pos[0]))
	      .attr('cy', d => yScale(d.tsne_pos[1]))
	      .style('fill', d => d3.schemeCategory10[d.label])
	      .on('mouseenter', function(event, d){
	        console.log(d);
	        d3.select(this).attr('r', 10);
	        svgA.append('svg:image').attr('xlink:href', 'data:image/jpg;base64,'+d.img)
		.attr('x', xScale(d.tsne_pos[0])).attr('y', yScale(d.tsne_pos[1]))
	            .attr('width', 100).attr('height', 100).attr('id', 'img');
	      })
	      .on('mouseleave', function(event, d){
	        d3.select(this).attr('r', 5);
	        svgA.select('#img').remove();
                  });
        });
    }

    function makeSectionB() {
        svgB.append('rect').attr('width', BWidth).attr('height', ABHeight)
	.style('fill', 'none').style('stroke', 'blue');
    }

    function makeSectionC() {
        svgC.append('rect').attr('width', CWidth).attr('height', CHeight)
	.style('fill', 'none').style('stroke', 'green');
    }

</script>
</html>
